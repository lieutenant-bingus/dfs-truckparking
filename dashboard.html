<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Truck Parking Monitor</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f6fa;
        color: #333;
        min-height: 100vh;
      }

      /* Header */
      .header {
        background: #2196F3;
        color: white;
        padding: 16px 30px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .header-logo {
        height: 40px;
        width: auto;
      }
      .header h1 {
        font-size: 22px;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .main-content {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Section titles */
      .section-title {
        font-size: 14px;
        color: #666;
        margin-bottom: 16px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      /* Traffic Counters Section */
      .traffic-section {
        margin-bottom: 40px;
      }
      .traffic-counters {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }
      .counter-card {
        background: white;
        border-radius: 8px;
        padding: 24px 32px;
        min-width: 220px;
        flex: 1;
        max-width: 300px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 4px solid #ccc;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .counter-card.ingress {
        border-left-color: #4CAF50;
      }
      .counter-card.egress {
        border-left-color: #f44336;
      }
      .counter-card.capacity {
        border-left-color: #2196F3;
        min-width: 280px;
        max-width: 350px;
      }
      .counter-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-align: center;
      }
      .counter-value {
        font-size: 48px;
        font-weight: 700;
      }
      .counter-card.ingress .counter-value {
        color: #4CAF50;
      }
      .counter-card.egress .counter-value {
        color: #f44336;
      }
      .counter-card.capacity .counter-value {
        color: #2196F3;
        font-size: 36px;
      }
      .capacity-percent {
        font-size: 16px;
        color: #666;
        margin-top: 4px;
        font-weight: 500;
      }
      .counter-updated {
        font-size: 11px;
        color: #999;
        margin-top: 8px;
      }

      /* Parking Spots Section */
      .spots-section {
        margin-top: 20px;
      }
      .spots-container {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }
      .grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: flex-start;
      }
      .widget {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 120px;
        padding: 12px;
        background: #f9f9f9;
        border-radius: 8px;
        transition: background 0.2s;
      }
      .widget:hover {
        background: #f0f0f0;
      }
      .circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: white;
        font-weight: bold;
        margin-bottom: 10px;
        transition: transform 0.2s;
      }
      .circle:hover {
        transform: scale(1.05);
      }
      .circle.open {
        background: #4CAF50;
      }
      .circle.occupied {
        background: #f44336;
      }
      .widget-name {
        text-align: center;
        font-size: 13px;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
      }
      .widget-updated {
        font-size: 10px;
        color: #999;
        text-align: center;
      }
      
      .no-data {
        text-align: center;
        color: #999;
        padding: 40px;
      }

      /* Camera Feed Section */
      .camera-section {
        margin-bottom: 40px;
      }
      .camera-container {
        background: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: inline-block;
      }
      .camera-wrapper {
        position: relative;
        display: inline-block;
      }
      .camera-feed {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        display: block;
      }
      /* Overlay markers */
      .spot-marker {
        position: absolute;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        color: white;
        border: 3px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        transform: translate(-50%, -50%);
        cursor: default;
        z-index: 10;
      }
      .spot-marker.open {
        background: #4CAF50;
      }
      .spot-marker.occupied {
        background: #f44336;
      }
      .spot-marker.unknown {
        background: #999;
      }
      /* Coordinate helper (for adding new spots) */
      .coord-display {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: #0f0;
        padding: 6px 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        z-index: 20;
        display: none;
      }
      .camera-wrapper:hover .coord-display {
        display: block;
      }
      /* Occupancy time styling */
      .widget-occupancy {
        font-size: 10px;
        color: #e74c3c;
        text-align: center;
        font-weight: 500;
        margin-top: 2px;
      }
    </style>
  </head>
  <body>
    <!-- Header with logo -->
    <header class="header">
<img src="logo.png" alt="Logo" class="header-logo" />
      <h1>Truck Parking Monitor</h1>
    </header>

    <div class="main-content">
      <!-- Traffic Counters -->
      <section class="traffic-section">
        <h2 class="section-title">Traffic Count</h2>
        <div class="traffic-counters">
          <div class="counter-card ingress">
            <div class="counter-label">Vehicles Entered Lot</div>
            <div class="counter-value" id="ingress-count">--</div>
            <div class="counter-updated" id="ingress-updated"></div>
          </div>
          <div class="counter-card egress">
            <div class="counter-label">Vehicles Exited Lot</div>
            <div class="counter-value" id="egress-count">--</div>
            <div class="counter-updated" id="egress-updated"></div>
          </div>
          <div class="counter-card capacity">
            <div class="counter-label">Lot Availability</div>
            <div class="counter-value" id="capacity-count">--/20</div>
            <div class="capacity-percent" id="capacity-percent">Lot capacity at --%</div>
            <div class="counter-updated" id="capacity-updated"></div>
          </div>
        </div>
      </section>

      <!-- Live Camera Feed with Overlay -->
      <section class="camera-section">
        <h2 class="section-title">Live Camera Feed</h2>
        <div class="camera-container">
          <div class="camera-wrapper" id="camera-wrapper">
            <img src="http://10.1.10.62/axis-cgi/mjpg/video.cgi" alt="Live Camera Feed" class="camera-feed" />
            
            <!-- Spot markers (positions in %) - Front row -->
            <div class="spot-marker unknown" id="marker-1" style="left: 6.1%; top: 55%;">1</div>
            <div class="spot-marker unknown" id="marker-2" style="left: 18.4%; top: 59%;">2</div>
            <div class="spot-marker unknown" id="marker-3" style="left: 40.8%; top: 58.4%;">3</div>
            <div class="spot-marker unknown" id="marker-4" style="left: 52.8%; top: 62.2%;">4</div>
            <div class="spot-marker unknown" id="marker-5" style="left: 66.7%; top: 61.2%;">5</div>
            <div class="spot-marker unknown" id="marker-6" style="left: 80%; top: 62.1%;">6</div>
            <div class="spot-marker unknown" id="marker-7" style="left: 95.3%; top: 62.2%;">7</div>
            
            <!-- Spot markers - Back row -->
            <div class="spot-marker unknown" id="marker-8" style="left: 95%; top: 40%;">8</div>
            <div class="spot-marker unknown" id="marker-9" style="left: 88%; top: 40%;">9</div>
            <div class="spot-marker unknown" id="marker-10" style="left: 78.2%; top: 39.9%;">10</div>
            
            <!-- Coordinate helper - hover over video to see x,y % -->
            <div class="coord-display" id="coord-display">X: --%, Y: --%</div>
          </div>
        </div>
      </section>

      <!-- Parking Spots -->
      <section class="spots-section">
        <h2 class="section-title">Parking Spots</h2>
        <div class="spots-container">
          <div id="grid" class="grid"></div>
        </div>
      </section>
    </div>

    <script>
      function formatTs(ts) {
        if (!ts) return "";
        const d = new Date(Number(ts));
        if (isNaN(d.getTime())) return ts;
        return d.toLocaleTimeString();
      }

      // Format duration from timestamp to now
      function formatDuration(startTs) {
        if (!startTs) return "";
        const start = Number(startTs);
        if (isNaN(start)) return "";
        
        const now = Date.now();
        const diffMs = now - start;
        if (diffMs < 0) return "";
        
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const mins = diffMins % 60;
        
        if (diffHours > 0) {
          return `${diffHours}h ${mins}m`;
        } else if (diffMins > 0) {
          return `${diffMins}m`;
        } else {
          return "<1m";
        }
      }

      async function load() {
        try {
          const res = await fetch("/api/widgets");
          const widgets = await res.json();

          if (!Array.isArray(widgets) || widgets.length === 0) {
            document.getElementById("grid").innerHTML = '<div class="no-data">No parking spot data yet.</div>';
            return;
          }

          // Separate traffic counters from parking spots
          let ingressWidget = null;
          let egressWidget = null;
          let capacityWidget = null;
          const parkingSpots = [];

          for (const w of widgets) {
            const nameLower = (w.name || "").toLowerCase().trim();
            if (nameLower === "ingress") {
              ingressWidget = w;
            } else if (nameLower.includes("egress")) {
              egressWidget = w;
            } else if (nameLower.includes("mega-zone")) {
              capacityWidget = w;
            } else if (w.name && w.name.toLowerCase().includes("spot")) {
              parkingSpots.push(w);
            }
          }

          // Update ingress counter
          if (ingressWidget) {
            const count = ingressWidget.object_count ?? ingressWidget.value ?? 0;
            document.getElementById("ingress-count").textContent = count;
            document.getElementById("ingress-updated").textContent = 
              ingressWidget.received_ts ? `Last update: ${formatTs(ingressWidget.received_ts)}` : "";
          }

          // Update egress counter
          if (egressWidget) {
            const count = egressWidget.object_count ?? egressWidget.value ?? 0;
            document.getElementById("egress-count").textContent = count;
            document.getElementById("egress-updated").textContent = 
              egressWidget.received_ts ? `Last update: ${formatTs(egressWidget.received_ts)}` : "";
          }

          // Update capacity counter (MEGA-ZONE)
          if (capacityWidget) {
            const totalSpots = 20;
            const occupied = capacityWidget.object_count ?? capacityWidget.value ?? 0;
            const available = totalSpots - occupied;
            const percentUsed = Math.round((occupied / totalSpots) * 100);
            
            document.getElementById("capacity-count").textContent = `${available}/${totalSpots} spots available`;
            document.getElementById("capacity-percent").textContent = `Lot capacity at ${percentUsed}%`;
            document.getElementById("capacity-updated").textContent = 
              capacityWidget.received_ts ? `Last update: ${formatTs(capacityWidget.received_ts)}` : "";
          }

          // Update overlay markers on camera feed
          updateMarkers(parkingSpots);

          // Render parking spots
          const grid = document.getElementById("grid");
          grid.innerHTML = "";

          if (parkingSpots.length === 0) {
            grid.innerHTML = '<div class="no-data">No parking spot data yet.</div>';
            return;
          }

          for (const w of parkingSpots) {
            const value = w.object_count ?? w.value ?? 0;
            const occupied = Number(value) >= 1;

            const div = document.createElement("div");
            div.className = "widget";

            const circle = document.createElement("div");
            circle.className = "circle " + (occupied ? "occupied" : "open");
            circle.textContent = occupied ? "FULL" : "OPEN";

            const name = document.createElement("div");
            name.className = "widget-name";
            // Clean up the name - remove "- Statistical value" and "- Value" suffixes
            let displayName = w.name || "";
            displayName = displayName.replace(/ - Statistical value$/i, "");
            displayName = displayName.replace(/ - Value$/i, "");
            name.textContent = displayName;

            const updated = document.createElement("div");
            updated.className = "widget-updated";
            updated.textContent = w.received_ts
              ? `${formatTs(w.received_ts)}`
              : "";

            div.appendChild(circle);
            div.appendChild(name);
            div.appendChild(updated);

            // Add occupancy time for FULL spots
            if (occupied && w.occupied_since) {
              const occupancy = document.createElement("div");
              occupancy.className = "widget-occupancy";
              occupancy.textContent = `Occupied since ${formatTs(w.occupied_since)}`;
              div.appendChild(occupancy);
            }

            grid.appendChild(div);
          }
        } catch (err) {
          console.error("Error loading widgets", err);
        }
      }

      // Update overlay markers based on spot data
      function updateMarkers(parkingSpots) {
        // Create a map of spot number -> occupied status
        const spotStatus = {};
        for (const w of parkingSpots) {
          // Extract spot number from name like "SPOT 1", "SPOT 2", etc.
          const match = (w.name || "").match(/SPOT\s*(\d+)/i);
          if (match) {
            const spotNum = parseInt(match[1]);
            const value = w.object_count ?? w.value ?? 0;
            spotStatus[spotNum] = Number(value) >= 1;
          }
        }
        
        // Update markers 1-10
        for (let i = 1; i <= 10; i++) {
          const marker = document.getElementById(`marker-${i}`);
          if (marker) {
            marker.classList.remove('open', 'occupied', 'unknown');
            if (spotStatus.hasOwnProperty(i)) {
              marker.classList.add(spotStatus[i] ? 'occupied' : 'open');
            } else {
              marker.classList.add('unknown');
            }
          }
        }
      }

      // Coordinate helper - shows x,y % when hovering over camera
      const wrapper = document.getElementById('camera-wrapper');
      const coordDisplay = document.getElementById('coord-display');
      if (wrapper && coordDisplay) {
        wrapper.addEventListener('mousemove', (e) => {
          const rect = wrapper.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width * 100).toFixed(1);
          const y = ((e.clientY - rect.top) / rect.height * 100).toFixed(1);
          coordDisplay.textContent = `X: ${x}%, Y: ${y}%`;
        });
      }

      load();
      setInterval(load, 3000);
    </script>
  </body>
</html>
