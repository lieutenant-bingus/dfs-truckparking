<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Truck Parking Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg-primary: #f5f6fa;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f9f9f9;
        --bg-hover: #f0f0f0;
        --text-primary: #333;
        --text-secondary: #666;
        --text-muted: #999;
        --border-color: #e0e0e0;
        --shadow: rgba(0,0,0,0.08);
        --header-bg: #2196F3;
      }
      
      [data-theme="dark"] {
        --bg-primary: #1a1a2e;
        --bg-secondary: #16213e;
        --bg-tertiary: #1f2940;
        --bg-hover: #243352;
        --text-primary: #e8e8e8;
        --text-secondary: #a0a0a0;
        --text-muted: #707070;
        --border-color: #2a3a5a;
        --shadow: rgba(0,0,0,0.3);
        --header-bg: #0f3460;
      }
      
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        transition: background 0.3s, color 0.3s;
      }

      /* Header */
      .header {
        background: var(--header-bg);
        color: white;
        padding: 16px 30px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: background 0.3s;
      }
      .header-logo {
        height: 40px;
        width: auto;
      }
      .header h1 {
        font-size: 22px;
        font-weight: 600;
        letter-spacing: 0.5px;
        flex: 1;
      }
      
      /* Dark mode toggle */
      .theme-toggle {
        background: rgba(255,255,255,0.2);
        border: none;
        border-radius: 20px;
        padding: 8px 16px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        transition: background 0.2s;
      }
      .theme-toggle:hover {
        background: rgba(255,255,255,0.3);
      }
      .theme-toggle-icon {
        font-size: 18px;
      }
      
      /* Alert Banner */
      .alert-banner {
        background: linear-gradient(135deg, #ff4757, #ff6b81);
        color: white;
        padding: 16px 30px;
        display: none;
        align-items: center;
        gap: 12px;
        font-weight: 600;
        animation: pulse-alert 2s infinite;
      }
      .alert-banner.visible {
        display: flex;
      }
      .alert-icon {
        font-size: 24px;
        animation: shake 0.5s infinite;
      }
      .alert-text {
        flex: 1;
      }
      .alert-time {
        font-size: 12px;
        opacity: 0.9;
        font-weight: 400;
      }
      @keyframes pulse-alert {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.85; }
      }
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-2px); }
        75% { transform: translateX(2px); }
      }

      .main-content {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Section titles */
      .section-title {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 16px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      /* Traffic Counters Section */
      .traffic-section {
        margin-bottom: 40px;
      }
      .traffic-counters {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }
      .counter-card {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 24px 32px;
        min-width: 220px;
        flex: 1;
        max-width: 300px;
        box-shadow: 0 2px 8px var(--shadow);
        border-left: 4px solid #ccc;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: background 0.3s, box-shadow 0.3s;
      }
      .counter-card.ingress {
        border-left-color: #4CAF50;
      }
      .counter-card.egress {
        border-left-color: #f44336;
      }
      .counter-card.capacity {
        border-left-color: #2196F3;
        min-width: 280px;
        max-width: 350px;
      }
      .counter-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-align: center;
      }
      .counter-value {
        font-size: 48px;
        font-weight: 700;
      }
      .counter-card.ingress .counter-value {
        color: #4CAF50;
      }
      .counter-card.egress .counter-value {
        color: #f44336;
      }
      .counter-card.capacity .counter-value {
        color: #2196F3;
        font-size: 36px;
      }
      .capacity-percent {
        font-size: 16px;
        color: var(--text-secondary);
        margin-top: 4px;
        font-weight: 500;
      }
      .counter-updated {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 8px;
      }

      /* Parking Spots Section */
      .spots-section {
        margin-top: 20px;
      }
      .spots-container {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 2px 8px var(--shadow);
        transition: background 0.3s, box-shadow 0.3s;
      }
      .grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: flex-start;
      }
      .widget {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 120px;
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        transition: background 0.2s;
      }
      .widget:hover {
        background: var(--bg-hover);
      }
      .circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: white;
        font-weight: bold;
        margin-bottom: 10px;
        transition: transform 0.2s;
      }
      .circle:hover {
        transform: scale(1.05);
      }
      .circle.open {
        background: #4CAF50;
      }
      .circle.occupied {
        background: #f44336;
      }
      .widget-name {
        text-align: center;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
      }
      .widget-updated {
        font-size: 10px;
        color: var(--text-muted);
        text-align: center;
      }
      
      .no-data {
        text-align: center;
        color: var(--text-muted);
        padding: 40px;
      }

      /* Camera Feed Section */
      .camera-section {
        margin-bottom: 40px;
      }
      .camera-container {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 8px var(--shadow);
        display: inline-block;
        transition: background 0.3s, box-shadow 0.3s;
      }
      
      /* Chart Section */
      .chart-section {
        margin-bottom: 40px;
      }
      .chart-container {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 2px 8px var(--shadow);
        transition: background 0.3s, box-shadow 0.3s;
      }
      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        flex-wrap: wrap;
        gap: 12px;
      }
      .chart-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .chart-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .time-range-btn {
        padding: 6px 12px;
        border: 1px solid var(--border-color);
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }
      .time-range-btn:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
      }
      .time-range-btn.active {
        background: #2196F3;
        color: white;
        border-color: #2196F3;
      }
      .expand-btn {
        padding: 6px 12px;
        border: 1px solid var(--border-color);
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .expand-btn:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
      }
      .chart-wrapper {
        position: relative;
        height: 250px;
      }
      .chart-note {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 12px;
        text-align: center;
        font-style: italic;
      }
      
      /* Modal for expanded chart */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal-overlay.visible {
        display: flex;
      }
      .modal-content {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 24px;
        width: 90%;
        max-width: 1200px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0;
        line-height: 1;
      }
      .modal-close:hover {
        color: var(--text-primary);
      }
      .modal-chart-wrapper {
        height: 400px;
        margin-bottom: 20px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-top: 20px;
      }
      .stat-card {
        background: var(--bg-tertiary);
        padding: 16px;
        border-radius: 8px;
        text-align: center;
      }
      .stat-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }
      .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
      }
      .stat-value.good { color: #4CAF50; }
      .stat-value.warning { color: #ff9800; }
      .stat-value.bad { color: #f44336; }
      .camera-wrapper {
        position: relative;
        display: inline-block;
      }
      .camera-feed {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        display: block;
      }
      /* Overlay markers */
      .spot-marker {
        position: absolute;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        color: white;
        border: 3px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        transform: translate(-50%, -50%);
        cursor: default;
        z-index: 10;
      }
      .spot-marker.open {
        background: #4CAF50;
      }
      .spot-marker.occupied {
        background: #f44336;
      }
      .spot-marker.unknown {
        background: #999;
      }
      .spot-marker.npz {
        background: #ff9800;
        font-size: 10px;
      }
      .spot-marker.npz.violation {
        background: #ff4757;
        animation: pulse-marker 1s infinite;
      }
      @keyframes pulse-marker {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.15); }
      }
      /* Coordinate helper (for adding new spots) */
      .coord-display {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: #0f0;
        padding: 6px 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        z-index: 20;
        display: none;
      }
      .camera-wrapper:hover .coord-display {
        display: block;
      }
      /* Occupancy time styling */
      .widget-occupancy {
        font-size: 10px;
        color: #e74c3c;
        text-align: center;
        font-weight: 500;
        margin-top: 2px;
      }
    </style>
  </head>
  <body>
    <!-- Alert Banner -->
    <div class="alert-banner" id="alert-banner">
      <span class="alert-icon">‚ö†Ô∏è</span>
      <span class="alert-text">
        <strong>NO PARKING ZONE VIOLATION!</strong> A vehicle is parked in a restricted area.
        <span class="alert-time" id="alert-time"></span>
      </span>
    </div>

    <!-- Header with logo -->
    <header class="header">
      <img src="logo.png" alt="Logo" class="header-logo" />
      <h1>Truck Parking Monitor</h1>
      <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()">
        <span class="theme-toggle-icon" id="theme-icon">üåô</span>
        <span id="theme-label">Dark Mode</span>
      </button>
    </header>

    <div class="main-content">
      <!-- Traffic Counters -->
      <section class="traffic-section">
        <h2 class="section-title">Traffic Count</h2>
        <div class="traffic-counters">
          <div class="counter-card ingress">
            <div class="counter-label">Vehicles Entered Lot</div>
            <div class="counter-value" id="ingress-count">--</div>
            <div class="counter-updated" id="ingress-updated"></div>
          </div>
          <div class="counter-card egress">
            <div class="counter-label">Vehicles Exited Lot</div>
            <div class="counter-value" id="egress-count">--</div>
            <div class="counter-updated" id="egress-updated"></div>
          </div>
          <div class="counter-card capacity">
            <div class="counter-label">Lot Availability</div>
            <div class="counter-value" id="capacity-count">--/20</div>
            <div class="capacity-percent" id="capacity-percent">Lot capacity at --%</div>
            <div class="counter-updated" id="capacity-updated"></div>
          </div>
        </div>
      </section>

      <!-- Live Camera Feed with Overlay -->
      <section class="camera-section">
        <h2 class="section-title">Live Camera Feed</h2>
        <div class="camera-container">
          <div class="camera-wrapper" id="camera-wrapper">
            <img src="http://10.1.10.62/axis-cgi/mjpg/video.cgi" alt="Live Camera Feed" class="camera-feed" />
            
            <!-- Spot markers (positions in %) - Front row -->
            <div class="spot-marker unknown" id="marker-1" style="left: 8.8%; top: 55%;">1</div>
            <div class="spot-marker unknown" id="marker-2" style="left: 18.4%; top: 55%;">2</div>
            <div class="spot-marker unknown" id="marker-3" style="left: 40.8%; top: 55%;">3</div>
            <div class="spot-marker unknown" id="marker-4" style="left: 52.8%; top: 55%;">4</div>
            <div class="spot-marker unknown" id="marker-5" style="left: 66.7%; top: 55%;">5</div>
            <div class="spot-marker unknown" id="marker-6" style="left: 80%; top: 55%;">6</div>
            <div class="spot-marker unknown" id="marker-7" style="left: 95.3%; top: 55%;">7</div>
            
            <!-- Spot markers - Back row -->
            <div class="spot-marker unknown" id="marker-8" style="left: 95%; top: 40%;">8</div>
            <div class="spot-marker unknown" id="marker-9" style="left: 88%; top: 40%;">9</div>
            <div class="spot-marker unknown" id="marker-10" style="left: 78.2%; top: 39.9%;">10</div>
            
            <!-- No Parking Zone marker -->
            <div class="spot-marker npz" id="marker-npz" style="left: 29%; top: 55%;">NPZ</div>
            
            <!-- Coordinate helper - hover over video to see x,y % -->
            <div class="coord-display" id="coord-display">X: --%, Y: --%</div>
          </div>
        </div>
      </section>

      <!-- Historical Chart -->
      <section class="chart-section">
        <h2 class="section-title">Occupancy History</h2>
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-controls">
              <button class="time-range-btn active" data-range="1h">1H</button>
              <button class="time-range-btn" data-range="6h">6H</button>
              <button class="time-range-btn" data-range="24h">24H</button>
              <button class="time-range-btn" data-range="7d">7D</button>
              <button class="time-range-btn" data-range="30d">30D</button>
            </div>
            <button class="expand-btn" onclick="openChartModal()">
              <span>üìä</span> Expand View
            </button>
          </div>
          <div class="chart-wrapper">
            <canvas id="occupancy-chart"></canvas>
          </div>
          <div class="chart-note">* Click "Expand View" for detailed statistics and larger chart</div>
        </div>
      </section>

      <!-- Chart Modal -->
      <div class="modal-overlay" id="chart-modal" onclick="closeChartModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
          <div class="modal-header">
            <span class="modal-title">üìä Detailed Occupancy History</span>
            <button class="modal-close" onclick="closeChartModal()">&times;</button>
          </div>
          <div class="chart-controls" style="margin-bottom: 16px;">
            <button class="time-range-btn modal-range active" data-range="1h">1 Hour</button>
            <button class="time-range-btn modal-range" data-range="6h">6 Hours</button>
            <button class="time-range-btn modal-range" data-range="24h">24 Hours</button>
            <button class="time-range-btn modal-range" data-range="7d">7 Days</button>
            <button class="time-range-btn modal-range" data-range="30d">30 Days</button>
          </div>
          <div class="modal-chart-wrapper">
            <canvas id="modal-chart"></canvas>
          </div>
          <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Average Occupancy</div>
              <div class="stat-value" id="stat-avg">--</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Peak Occupancy</div>
              <div class="stat-value bad" id="stat-peak">--</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Minimum</div>
              <div class="stat-value good" id="stat-min">--</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Data Points</div>
              <div class="stat-value" id="stat-count">--</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg Utilization</div>
              <div class="stat-value" id="stat-util">--%</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Time at Capacity</div>
              <div class="stat-value warning" id="stat-full-time">--</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Parking Spots -->
      <section class="spots-section">
        <h2 class="section-title">Parking Spots</h2>
        <div class="spots-container">
          <div id="grid" class="grid"></div>
        </div>
      </section>
    </div>

    <script>
      // ========== DARK MODE ==========
      function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeButton(savedTheme);
      }
      
      function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const newTheme = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeButton(newTheme);
        updateChartTheme();
      }
      
      function updateThemeButton(theme) {
        const icon = document.getElementById('theme-icon');
        const label = document.getElementById('theme-label');
        if (theme === 'dark') {
          icon.textContent = '‚òÄÔ∏è';
          label.textContent = 'Light Mode';
        } else {
          icon.textContent = 'üåô';
          label.textContent = 'Dark Mode';
        }
      }
      
      // Initialize theme on page load
      initTheme();

      // ========== CHART ==========
      let occupancyChart = null;
      let modalChart = null;
      let currentRange = '1h';
      let currentHistoryData = [];
      
      function getChartColors() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        return {
          line: '#2196F3',
          fill: isDark ? 'rgba(33, 150, 243, 0.2)' : 'rgba(33, 150, 243, 0.1)',
          grid: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
          text: isDark ? '#a0a0a0' : '#666'
        };
      }
      
      function formatTimeLabel(timestamp, range) {
        const d = new Date(timestamp);
        if (range === '7d' || range === '30d') {
          return d.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + 
                 d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      
      async function loadHistory(range = currentRange) {
        currentRange = range;
        try {
          const res = await fetch(`/api/history?range=${range}&limit=1000`);
          const history = await res.json();
          currentHistoryData = history;
          
          if (!history || history.length === 0) {
            return;
          }
          
          const labels = history.map(h => formatTimeLabel(h.timestamp, range));
          const data = history.map(h => h.occupied);
          
          const ctx = document.getElementById('occupancy-chart').getContext('2d');
          const colors = getChartColors();
          
          if (occupancyChart) {
            occupancyChart.data.labels = labels;
            occupancyChart.data.datasets[0].data = data;
            occupancyChart.update('none');
          } else {
            occupancyChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Vehicles in Lot',
                  data: data,
                  borderColor: colors.line,
                  backgroundColor: colors.fill,
                  fill: true,
                  tension: 0.3,
                  pointRadius: data.length > 100 ? 0 : 2,
                  pointHoverRadius: 5
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  intersect: false,
                  mode: 'index'
                },
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      title: function(context) {
                        const idx = context[0].dataIndex;
                        const ts = currentHistoryData[idx]?.timestamp;
                        if (ts) {
                          return new Date(ts).toLocaleString();
                        }
                        return context[0].label;
                      },
                      label: function(context) {
                        return `Occupied: ${context.parsed.y} / 20 spots (${Math.round(context.parsed.y / 20 * 100)}%)`;
                      }
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    max: 20,
                    grid: {
                      color: colors.grid
                    },
                    ticks: {
                      color: colors.text,
                      stepSize: 5
                    },
                    title: {
                      display: true,
                      text: 'Occupied Spots',
                      color: colors.text
                    }
                  },
                  x: {
                    grid: {
                      color: colors.grid
                    },
                    ticks: {
                      color: colors.text,
                      maxTicksLimit: 10,
                      maxRotation: 45,
                      minRotation: 0
                    }
                  }
                }
              }
            });
          }
        } catch (err) {
          console.error('Error loading history', err);
        }
      }
      
      function updateChartTheme() {
        const colors = getChartColors();
        
        if (occupancyChart) {
          occupancyChart.data.datasets[0].borderColor = colors.line;
          occupancyChart.data.datasets[0].backgroundColor = colors.fill;
          occupancyChart.options.scales.y.grid.color = colors.grid;
          occupancyChart.options.scales.y.ticks.color = colors.text;
          occupancyChart.options.scales.y.title.color = colors.text;
          occupancyChart.options.scales.x.grid.color = colors.grid;
          occupancyChart.options.scales.x.ticks.color = colors.text;
          occupancyChart.update('none');
        }
        
        if (modalChart) {
          modalChart.data.datasets[0].borderColor = colors.line;
          modalChart.data.datasets[0].backgroundColor = colors.fill;
          modalChart.options.scales.y.grid.color = colors.grid;
          modalChart.options.scales.y.ticks.color = colors.text;
          modalChart.options.scales.y.title.color = colors.text;
          modalChart.options.scales.x.grid.color = colors.grid;
          modalChart.options.scales.x.ticks.color = colors.text;
          modalChart.update('none');
        }
      }
      
      // Time range button handlers
      document.querySelectorAll('.time-range-btn:not(.modal-range)').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.time-range-btn:not(.modal-range)').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          loadHistory(btn.dataset.range);
        });
      });
      
      // Modal functions
      function openChartModal() {
        const modal = document.getElementById('chart-modal');
        modal.classList.add('visible');
        document.body.style.overflow = 'hidden';
        loadModalChart(currentRange);
      }
      
      function closeChartModal(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('chart-modal');
        modal.classList.remove('visible');
        document.body.style.overflow = '';
      }
      
      async function loadModalChart(range) {
        try {
          const res = await fetch(`/api/history?range=${range}&limit=2000`);
          const history = await res.json();
          
          if (!history || history.length === 0) {
            return;
          }
          
          // Update stats
          const data = history.map(h => h.occupied);
          const avg = data.reduce((a, b) => a + b, 0) / data.length;
          const peak = Math.max(...data);
          const min = Math.min(...data);
          const fullCount = data.filter(d => d >= 18).length; // 90% capacity
          
          document.getElementById('stat-avg').textContent = avg.toFixed(1);
          document.getElementById('stat-peak').textContent = peak;
          document.getElementById('stat-min').textContent = min;
          document.getElementById('stat-count').textContent = data.length;
          document.getElementById('stat-util').textContent = `${Math.round(avg / 20 * 100)}%`;
          document.getElementById('stat-full-time').textContent = `${Math.round(fullCount / data.length * 100)}%`;
          
          // Build chart
          const labels = history.map(h => formatTimeLabel(h.timestamp, range));
          const ctx = document.getElementById('modal-chart').getContext('2d');
          const colors = getChartColors();
          
          if (modalChart) {
            modalChart.data.labels = labels;
            modalChart.data.datasets[0].data = data;
            modalChart.update('none');
          } else {
            modalChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Vehicles in Lot',
                  data: data,
                  borderColor: colors.line,
                  backgroundColor: colors.fill,
                  fill: true,
                  tension: 0.3,
                  pointRadius: data.length > 200 ? 0 : 2,
                  pointHoverRadius: 5
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  intersect: false,
                  mode: 'index'
                },
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      title: function(context) {
                        const idx = context[0].dataIndex;
                        const ts = history[idx]?.timestamp;
                        if (ts) {
                          return new Date(ts).toLocaleString();
                        }
                        return context[0].label;
                      },
                      label: function(context) {
                        return `Occupied: ${context.parsed.y} / 20 spots (${Math.round(context.parsed.y / 20 * 100)}%)`;
                      }
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    max: 20,
                    grid: {
                      color: colors.grid
                    },
                    ticks: {
                      color: colors.text,
                      stepSize: 5
                    },
                    title: {
                      display: true,
                      text: 'Occupied Spots',
                      color: colors.text
                    }
                  },
                  x: {
                    grid: {
                      color: colors.grid
                    },
                    ticks: {
                      color: colors.text,
                      maxTicksLimit: 15,
                      maxRotation: 45,
                      minRotation: 0
                    }
                  }
                }
              }
            });
          }
        } catch (err) {
          console.error('Error loading modal chart', err);
        }
      }
      
      // Modal time range button handlers
      document.querySelectorAll('.modal-range').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.modal-range').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          loadModalChart(btn.dataset.range);
        });
      });
      
      // Close modal with Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeChartModal();
      });
      
      // Load chart on startup
      loadHistory();

      // ========== UTILITIES ==========
      function formatTs(ts) {
        if (!ts) return "";
        const d = new Date(Number(ts));
        if (isNaN(d.getTime())) return ts;
        return d.toLocaleTimeString();
      }

      // Format duration from timestamp to now
      function formatDuration(startTs) {
        if (!startTs) return "";
        const start = Number(startTs);
        if (isNaN(start)) return "";
        
        const now = Date.now();
        const diffMs = now - start;
        if (diffMs < 0) return "";
        
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);
        const hours = diffHours % 24;
        const mins = diffMins % 60;
        
        if (diffDays > 0) {
          return `${diffDays}d ${hours}h`;
        } else if (diffHours > 0) {
          return `${diffHours}h ${mins}m`;
        } else if (diffMins > 0) {
          return `${diffMins}m`;
        } else {
          return "<1m";
        }
      }

      // ========== MAIN DATA LOAD ==========
      async function load() {
        try {
          const res = await fetch("/api/widgets");
          const widgets = await res.json();

          if (!Array.isArray(widgets) || widgets.length === 0) {
            document.getElementById("grid").innerHTML = '<div class="no-data">No parking spot data yet.</div>';
            return;
          }

          // Separate traffic counters from parking spots
          let ingressWidget = null;
          let egressWidget = null;
          let capacityWidget = null;
          let noParkZoneWidget = null;
          const parkingSpots = [];

          for (const w of widgets) {
            const nameLower = (w.name || "").toLowerCase().trim();
            if (nameLower === "ingress") {
              ingressWidget = w;
            } else if (nameLower.includes("egress")) {
              egressWidget = w;
            } else if (nameLower.includes("mega-zone")) {
              capacityWidget = w;
            } else if (nameLower.includes("noparkzone")) {
              noParkZoneWidget = w;
            } else if (w.name && w.name.toLowerCase().includes("spot")) {
              parkingSpots.push(w);
            }
          }

          // Deduplicate parking spots - keep only one per spot number (most recent)
          const spotsByNumber = {};
          for (const w of parkingSpots) {
            const match = (w.name || "").match(/SPOT\s*(\d+)/i);
            if (match) {
              const spotNum = match[1];
              const existing = spotsByNumber[spotNum];
              // Keep the most recently updated one
              if (!existing || (w.received_ts > existing.received_ts)) {
                spotsByNumber[spotNum] = w;
              }
            }
          }
          // Convert back to array and sort by spot number
          const dedupedSpots = Object.entries(spotsByNumber)
            .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
            .map(entry => entry[1]);

          // Update No Parking Zone alert
          updateNoParkZoneAlert(noParkZoneWidget);

          // Update ingress counter
          if (ingressWidget) {
            const count = ingressWidget.object_count ?? ingressWidget.value ?? 0;
            document.getElementById("ingress-count").textContent = count;
            document.getElementById("ingress-updated").textContent = 
              ingressWidget.received_ts ? `Last update: ${formatTs(ingressWidget.received_ts)}` : "";
          }

          // Update egress counter
          if (egressWidget) {
            const count = egressWidget.object_count ?? egressWidget.value ?? 0;
            document.getElementById("egress-count").textContent = count;
            document.getElementById("egress-updated").textContent = 
              egressWidget.received_ts ? `Last update: ${formatTs(egressWidget.received_ts)}` : "";
          }

          // Update capacity counter (MEGA-ZONE)
          if (capacityWidget) {
            const totalSpots = 20;
            const occupied = capacityWidget.object_count ?? capacityWidget.value ?? 0;
            const available = totalSpots - occupied;
            const percentUsed = Math.round((occupied / totalSpots) * 100);
            
            document.getElementById("capacity-count").textContent = `${available}/${totalSpots} spots available`;
            document.getElementById("capacity-percent").textContent = `Lot capacity at ${percentUsed}%`;
            document.getElementById("capacity-updated").textContent = 
              capacityWidget.received_ts ? `Last update: ${formatTs(capacityWidget.received_ts)}` : "";
          }

          // Update overlay markers on camera feed
          updateMarkers(dedupedSpots);

          // Render parking spots
          const grid = document.getElementById("grid");
          grid.innerHTML = "";

          if (dedupedSpots.length === 0) {
            grid.innerHTML = '<div class="no-data">No parking spot data yet.</div>';
            return;
          }

          for (const w of dedupedSpots) {
            const value = w.object_count ?? w.value ?? 0;
            const occupied = Number(value) >= 1;

            const div = document.createElement("div");
            div.className = "widget";

            const circle = document.createElement("div");
            circle.className = "circle " + (occupied ? "occupied" : "open");
            circle.textContent = occupied ? "FULL" : "OPEN";

            const name = document.createElement("div");
            name.className = "widget-name";
            // Clean up the name - remove "- Statistical value" and "- Value" suffixes
            let displayName = w.name || "";
            displayName = displayName.replace(/ - Statistical value$/i, "");
            displayName = displayName.replace(/ - Value$/i, "");
            name.textContent = displayName;

            const updated = document.createElement("div");
            updated.className = "widget-updated";
            updated.textContent = w.received_ts
              ? `${formatTs(w.received_ts)}`
              : "";

            div.appendChild(circle);
            div.appendChild(name);
            div.appendChild(updated);

            // Add occupancy time for FULL spots
            if (occupied && w.occupied_since) {
              const occupancy = document.createElement("div");
              occupancy.className = "widget-occupancy";
              const duration = formatDuration(w.occupied_since);
              occupancy.innerHTML = `Occupied since<br>${formatTs(w.occupied_since)}`;
              if (duration) {
                const durationSpan = document.createElement("div");
                durationSpan.style.marginTop = "2px";
                durationSpan.style.fontWeight = "600";
                durationSpan.textContent = `(${duration})`;
                occupancy.appendChild(durationSpan);
              }
              div.appendChild(occupancy);
            }

            grid.appendChild(div);
          }
        } catch (err) {
          console.error("Error loading widgets", err);
        }
      }

      // Update No Parking Zone alert banner and marker
      function updateNoParkZoneAlert(noParkZoneWidget) {
        const alertBanner = document.getElementById('alert-banner');
        const alertTime = document.getElementById('alert-time');
        const npzMarker = document.getElementById('marker-npz');
        
        if (noParkZoneWidget) {
          const count = noParkZoneWidget.object_count ?? noParkZoneWidget.value ?? 0;
          const isViolation = Number(count) >= 1;
          
          if (isViolation) {
            alertBanner.classList.add('visible');
            if (noParkZoneWidget.received_ts) {
              alertTime.textContent = ` ‚Äî Detected at ${formatTs(noParkZoneWidget.received_ts)}`;
            }
            npzMarker.classList.add('violation');
          } else {
            alertBanner.classList.remove('visible');
            npzMarker.classList.remove('violation');
          }
        } else {
          alertBanner.classList.remove('visible');
          if (npzMarker) npzMarker.classList.remove('violation');
        }
      }

      // Update overlay markers based on spot data
      function updateMarkers(parkingSpots) {
        // Create a map of spot number -> occupied status
        const spotStatus = {};
        for (const w of parkingSpots) {
          // Extract spot number from name like "SPOT 1", "SPOT 2", etc.
          const match = (w.name || "").match(/SPOT\s*(\d+)/i);
          if (match) {
            const spotNum = parseInt(match[1]);
            const value = w.object_count ?? w.value ?? 0;
            spotStatus[spotNum] = Number(value) >= 1;
          }
        }
        
        // Update markers 1-10
        for (let i = 1; i <= 10; i++) {
          const marker = document.getElementById(`marker-${i}`);
          if (marker) {
            marker.classList.remove('open', 'occupied', 'unknown');
            if (spotStatus.hasOwnProperty(i)) {
              marker.classList.add(spotStatus[i] ? 'occupied' : 'open');
            } else {
              marker.classList.add('unknown');
            }
          }
        }
      }

      // Coordinate helper - shows x,y % when hovering over camera
      const wrapper = document.getElementById('camera-wrapper');
      const coordDisplay = document.getElementById('coord-display');
      if (wrapper && coordDisplay) {
        wrapper.addEventListener('mousemove', (e) => {
          const rect = wrapper.getBoundingClientRect();
          const x = ((e.clientX - rect.left) / rect.width * 100).toFixed(1);
          const y = ((e.clientY - rect.top) / rect.height * 100).toFixed(1);
          coordDisplay.textContent = `X: ${x}%, Y: ${y}%`;
        });
      }

      load();
      setInterval(load, 5000);  // Poll every 5 seconds (reduced from 3)
      
      // Refresh chart less frequently (every 30 seconds)
      setInterval(loadHistory, 30000);
    </script>
  </body>
</html>
