<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Truck Parking Monitor</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f6fa;
        color: #333;
        min-height: 100vh;
      }

      /* Header */
      .header {
        background: #2196F3;
        color: white;
        padding: 16px 30px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .header-logo {
        height: 40px;
        width: auto;
      }
      .header h1 {
        font-size: 22px;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .main-content {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Section titles */
      .section-title {
        font-size: 14px;
        color: #666;
        margin-bottom: 16px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      /* Traffic Counters Section */
      .traffic-section {
        margin-bottom: 40px;
      }
      .traffic-counters {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }
      .counter-card {
        background: white;
        border-radius: 8px;
        padding: 24px 32px;
        min-width: 220px;
        flex: 1;
        max-width: 300px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 4px solid #ccc;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .counter-card.ingress {
        border-left-color: #4CAF50;
      }
      .counter-card.egress {
        border-left-color: #f44336;
      }
      .counter-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-align: center;
      }
      .counter-value {
        font-size: 48px;
        font-weight: 700;
      }
      .counter-card.ingress .counter-value {
        color: #4CAF50;
      }
      .counter-card.egress .counter-value {
        color: #f44336;
      }
      .counter-updated {
        font-size: 11px;
        color: #999;
        margin-top: 8px;
      }

      /* Parking Spots Section */
      .spots-section {
        margin-top: 20px;
      }
      .spots-container {
        background: white;
        border-radius: 8px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }
      .grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: flex-start;
      }
      .widget {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 120px;
        padding: 12px;
        background: #f9f9f9;
        border-radius: 8px;
        transition: background 0.2s;
      }
      .widget:hover {
        background: #f0f0f0;
      }
      .circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: white;
        font-weight: bold;
        margin-bottom: 10px;
        transition: transform 0.2s;
      }
      .circle:hover {
        transform: scale(1.05);
      }
      .circle.open {
        background: #4CAF50;
      }
      .circle.occupied {
        background: #f44336;
      }
      .widget-name {
        text-align: center;
        font-size: 13px;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
      }
      .widget-updated {
        font-size: 10px;
        color: #999;
        text-align: center;
      }
      
      .no-data {
        text-align: center;
        color: #999;
        padding: 40px;
      }
    </style>
  </head>
  <body>
    <!-- Header with logo -->
    <header class="header">
      <!-- 
        TO ADD YOUR OWN LOGO:
        1. Add your image file to this folder (e.g., "logo.png")
        2. Uncomment the <img> tag below and update the src
        3. Or use a URL to an image hosted online
      -->
      <!-- <img src="logo.png" alt="Logo" class="header-logo" /> -->
      <h1>Truck Parking Monitor</h1>
    </header>

    <div class="main-content">
      <!-- Traffic Counters -->
      <section class="traffic-section">
        <h2 class="section-title">Traffic Count</h2>
        <div class="traffic-counters">
          <div class="counter-card ingress">
            <div class="counter-label">Vehicles Entered Lot</div>
            <div class="counter-value" id="ingress-count">--</div>
            <div class="counter-updated" id="ingress-updated"></div>
          </div>
          <div class="counter-card egress">
            <div class="counter-label">Vehicles Exited Lot</div>
            <div class="counter-value" id="egress-count">--</div>
            <div class="counter-updated" id="egress-updated"></div>
          </div>
        </div>
      </section>

      <!-- Parking Spots -->
      <section class="spots-section">
        <h2 class="section-title">Parking Spots</h2>
        <div class="spots-container">
          <div id="grid" class="grid"></div>
        </div>
      </section>
    </div>

    <script>
      function formatTs(ts) {
        if (!ts) return "";
        const d = new Date(Number(ts));
        if (isNaN(d.getTime())) return ts;
        return d.toLocaleTimeString();
      }

      async function load() {
        try {
          const res = await fetch("/api/widgets");
          const widgets = await res.json();

          if (!Array.isArray(widgets) || widgets.length === 0) {
            document.getElementById("grid").innerHTML = '<div class="no-data">No parking spot data yet.</div>';
            return;
          }

          // Separate traffic counters from parking spots
          let ingressWidget = null;
          let egressWidget = null;
          const parkingSpots = [];

          for (const w of widgets) {
            const nameLower = (w.name || "").toLowerCase().trim();
            if (nameLower === "ingress") {
              ingressWidget = w;
            } else if (nameLower.includes("egress")) {
              egressWidget = w;
            } else if (w.name && w.name.toLowerCase().includes("spot")) {
              parkingSpots.push(w);
            }
          }

          // Update ingress counter
          if (ingressWidget) {
            const count = ingressWidget.object_count ?? ingressWidget.value ?? 0;
            document.getElementById("ingress-count").textContent = count;
            document.getElementById("ingress-updated").textContent = 
              ingressWidget.received_ts ? `Last update: ${formatTs(ingressWidget.received_ts)}` : "";
          }

          // Update egress counter
          if (egressWidget) {
            const count = egressWidget.object_count ?? egressWidget.value ?? 0;
            document.getElementById("egress-count").textContent = count;
            document.getElementById("egress-updated").textContent = 
              egressWidget.received_ts ? `Last update: ${formatTs(egressWidget.received_ts)}` : "";
          }

          // Render parking spots
          const grid = document.getElementById("grid");
          grid.innerHTML = "";

          if (parkingSpots.length === 0) {
            grid.innerHTML = '<div class="no-data">No parking spot data yet.</div>';
            return;
          }

          for (const w of parkingSpots) {
            const value = w.object_count ?? w.value ?? 0;
            const occupied = Number(value) >= 1;

            const div = document.createElement("div");
            div.className = "widget";

            const circle = document.createElement("div");
            circle.className = "circle " + (occupied ? "occupied" : "open");
            circle.textContent = occupied ? "FULL" : "OPEN";

            const name = document.createElement("div");
            name.className = "widget-name";
            // Clean up the name - remove "- Statistical value" and "- Value" suffixes
            let displayName = w.name || "";
            displayName = displayName.replace(/ - Statistical value$/i, "");
            displayName = displayName.replace(/ - Value$/i, "");
            name.textContent = displayName;

            const updated = document.createElement("div");
            updated.className = "widget-updated";
            updated.textContent = w.received_ts
              ? `${formatTs(w.received_ts)}`
              : "";

            div.appendChild(circle);
            div.appendChild(name);
            div.appendChild(updated);

            grid.appendChild(div);
          }
        } catch (err) {
          console.error("Error loading widgets", err);
        }
      }

      load();
      setInterval(load, 3000);
    </script>
  </body>
</html>
